<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Gratuitos!">
    <meta name="theme-color" content="#006400">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="/manifest.json">
    <title>Gratuitos! - Fixados</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/marlonexpert/icones/main/logo1.png">
    <link rel="icon" href="https://raw.githubusercontent.com/marlonexpert/icones/main/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #F0F2F5; --text-color: #333333; --text-color-light: #4A4A4A;
            --card-bg-color: #FFFFFF; --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --header-bg-color: transparent; --input-bg-color: #F8F8F8; --input-border-color: #DDDDDD;
            --button-bg-color: #E0E0E0; --button-text-color: #333333; --icon-bg-color: #555;
            --separator-color: #EEEEEE; --primary-color: #007BFF; --primary-color-rgb: 0, 123, 255;
            --primary-color-hover: #0069D9; --danger-color: #DC3545; --context-menu-bg: #FFFFFF;
            --context-menu-border: #EEEEEE; --context-menu-item-hover: #F0F0F0;
            --header-height-desktop: 60px; --header-height-mobile: 50px;
            --icon-add-color: #006400; --icon-add-color-rgb: 0, 100, 0;
            --success-color: #28A745; --edit-button-color: #006400;
        }
        body.dark-mode {
            --bg-color: #121212; --text-color: #EAEAEA; --text-color-light: #a0a0a0;
            --card-bg-color: #1E1E1E; --card-shadow: none; --header-bg-color: transparent;
            --input-bg-color: #252525; --input-border-color: #383838; --button-bg-color: #333333;
            --button-text-color: #EAEAEA; --icon-bg-color: #333742; --separator-color: #383838;
            --context-menu-bg: #252525; --context-menu-border: #383838; --context-menu-item-hover: #383838;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); padding-top: var(--header-height-desktop); transition: background-color .3s ease, color .3s ease; }
        main { padding: 25px; width: 100%; max-width: 1400px; margin: 0 auto; box-sizing: border-box; }
        #page-header { position: fixed; top: 0; left: 0; width: 100%; padding: 10px 25px; background-color: rgba(var(--primary-color-rgb), 0.05); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 1000; display: flex; justify-content: center; align-items: center; box-sizing: border-box; }
        .header-content { width: 100%; max-width: 1400px; display: flex; justify-content: flex-end; gap: 5px; align-items: center; position: relative; }
        #gratuito-phrase { position: absolute; left: 0; font-family: 'Dancing Script', cursive; font-size: 1.7em; color: var(--text-color); cursor: pointer; transition: opacity 0.3s; }
        #gratuito-phrase.hidden { opacity: 0; pointer-events: none; }
        #search-input { flex-grow: 1; padding: 8px 18px; border: 1px solid var(--input-border-color); border-radius: 25px; background-color: var(--input-bg-color); color: var(--text-color); outline: none; transition: width 0.3s, opacity 0.3s; height: 40px; width: 0; opacity: 0; pointer-events: none; }
        #search-input.active { width: 100%; opacity: 1; pointer-events: all; margin-right: 10px; }
        .header-button { background-color: var(--button-bg-color); color: var(--button-text-color); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all .2s; }
        #search-button-toggle, #auto-publish-button, #edit-mode-toggle { background-color: var(--icon-add-color); color: white; }
        #theme-toggle { border-radius: 25px; width: auto; min-width: 90px; padding: 0 10px; gap: 8px; }
        #theme-toggle span { font-size: 0.75em; font-weight: 600; }
        .category-card { background-color: var(--card-bg-color); box-shadow: var(--card-shadow); margin-bottom: 25px; border-radius: 12px; overflow: hidden; border: 1px solid transparent; }
        body.dark-mode .category-card { border-color: var(--separator-color); }
        .category-header { padding: 15px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .category-header h2 { margin: 0; font-size: 1.2em; }
        .category-header::after { content: '−'; font-size: 1.5em; transition: 0.3s; }
        .category-card.collapsed .category-header::after { content: '+'; transform: rotate(-90deg); }
        .icons-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; padding: 20px; border-top: 1px solid var(--separator-color); transition: max-height 0.3s; }
        .category-card.collapsed .icons-grid { max-height: 0; padding: 0; border-top-color: transparent; }
        .icon-card-wrapper { position: relative; }
        .icon-link { display: flex; text-decoration: none; border-radius: 12px; height: 90px; overflow: hidden; background-color: var(--icon-bg-color); transition: transform 0.2s; }
        .icon-link:hover { transform: scale(1.03); }
        .icon-visual { display: flex; align-items: center; justify-content: center; width: 100%; padding: 10px; }
        .icon-title { color: white; font-weight: 600; text-align: center; text-transform: uppercase; font-size: 0.9em; }
        .icon-actions-button { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.3); border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; display: none; }
        body.edit-mode-active .icon-actions-button { display: flex; align-items: center; justify-content: center; }
        .context-menu { position: absolute; top: 35px; right: 5px; background: var(--context-menu-bg); border: 1px solid var(--context-menu-border); border-radius: 8px; z-index: 100; list-style: none; padding: 5px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .context-menu li { padding: 8px 15px; cursor: pointer; white-space: nowrap; }
        .context-menu li:hover { background: var(--context-menu-item-hover); }
        #generator-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 2000; }
        #generate-icon-code-section { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg-color); padding: 25px; border-radius: 12px; z-index: 2001; display: none; width: 90%; max-width: 500px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9em; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--input-border-color); background: var(--input-bg-color); color: var(--text-color); box-sizing: border-box; }
        #submit-icon-button { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        #confirmation-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--success-color); color: white; padding: 10px 20px; border-radius: 20px; display: none; z-index: 3000; }
        @media (max-width: 768px) {
            .icons-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
            #gratuito-phrase { font-size: 1.3em; }
        }
    </style>
</head>
<body>
    <header id="page-header">
        <div class="header-content">
            <div id="gratuito-phrase">Aqui tudo é gratuito</div>
            <button id="search-button-toggle" class="header-button"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></button>
            <input type="text" id="search-input" placeholder="Pesquisar...">
            <button id="edit-mode-toggle" class="header-button"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>
            <button id="auto-publish-button" class="header-button"><svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>
            <button id="theme-toggle" class="header-button"><span>Claro</span></button>
        </div>
    </header>

    <main id="main-content">
        <div id="all-categories-grid"></div>
        <div id="search-results-container" class="icons-grid" style="display:none"></div>
    </main>

    <div id="generator-modal-overlay"></div>
    <div id="generate-icon-code-section">
        <h2 style="margin-top:0">Novo Ícone</h2>
        <form id="icon-form">
            <input type="hidden" id="iconIdInput">
            <div class="form-group"><label>Nome</label><input type="text" id="iconNameInput" required></div>
            <div class="form-group"><label>Link</label><input type="text" id="iconLinkInput" required></div>
            <div class="form-group"><label>Cor (Hex)</label><input type="color" id="iconColorInput" value="#006400"></div>
            <div class="form-group">
                <label>Categoria</label>
                <select id="iconCategorySelect" required>
                    <option value="servicos-utilidades">Serviços & Utilidades</option>
                    <option value="cursos-concursos">Cursos & Concursos</option>
                    <option value="ferramentas-downloads">Ferramentas & Downloads</option>
                    <option value="compras-produtividade">Compras & Produtividade</option>
                    <option value="design-audio">Design & Áudio</option>
                    <option value="midia-entretenimento">Mídia & Entretenimento</option>
                </select>
            </div>
            <div style="display:flex; gap:10px">
                <button type="submit" id="submit-icon-button">Salvar</button>
                <button type="button" id="close-modal" style="flex:1; background:#ccc; border:none; border-radius:8px; cursor:pointer">Cancelar</button>
            </div>
        </form>
    </div>

    <div id="confirmation-toast">Copiado!</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const config = {
            firebase: { apiKey: "AIzaSyDo4HgnZG9To1aeDoAbUd7vbfgSUAHHtSs", authDomain: "iconesutil.firebaseapp.com", projectId: "iconesutil", storageBucket: "iconesutil.appspot.com", messagingSenderId: "88285859566", appId: "1:88285859566:web:e15fdb0c615b494955edff" },
            categories: { 'servicos-utilidades': 'Serviços & Utilidades', 'cursos-concursos': 'Cursos & Concursos', 'ferramentas-downloads': 'Ferramentas & Downloads', 'compras-produtividade': 'Compras & Produtividade', 'design-audio': 'Design & Áudio', 'midia-entretenimento': 'Mídia & Entretenimento' }
        };

        const state = { allIcons: [], isEditMode: false, searchTerm: '' };

        const FirebaseService = {
            db: null,
            init() {
                const app = initializeApp(config.firebase);
                this.db = getFirestore(app);
                const auth = getAuth(app);
                onAuthStateChanged(auth, user => { if(!user) signInAnonymously(auth); });
            },
            listen(callback) {
                onSnapshot(collection(this.db, "icones"), snap => {
                    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    localStorage.setItem('cachedIcons', JSON.stringify(data)); // Salva para a próxima vez
                    callback(data);
                });
            }
        };

        const UI = {
            render() {
                const grid = document.getElementById('all-categories-grid');
                const searchGrid = document.getElementById('search-results-container');
                grid.innerHTML = ''; searchGrid.innerHTML = '';

                if (state.searchTerm) {
                    grid.style.display = 'none';
                    searchGrid.style.display = 'grid';
                    const filtered = state.allIcons.filter(i => i.name.toLowerCase().includes(state.searchTerm));
                    filtered.forEach(i => searchGrid.appendChild(this.createIcon(i)));
                } else {
                    grid.style.display = 'block';
                    searchGrid.style.display = 'none';
                    
                    const pinned = state.allIcons.filter(i => i.isPinned);
                    if (pinned.length) grid.appendChild(this.createCategory('fixados', 'Acesso Rápido', pinned, false));

                    Object.entries(config.categories).forEach(([id, name]) => {
                        const catIcons = state.allIcons.filter(i => i.category === id && !i.isPinned);
                        if (catIcons.length) grid.appendChild(this.createCategory(id, name, catIcons, true));
                    });
                }
            },
            createIcon(icon) {
                const wrap = document.createElement('div');
                wrap.className = 'icon-card-wrapper';
                wrap.innerHTML = `
                    <a href="${icon.link}" class="icon-link" target="_blank" style="background:${icon.color || '#006400'}">
                        <div class="icon-visual"><span class="icon-title">${icon.name}</span></div>
                    </a>
                    <button class="icon-actions-button"><svg width="16" height="16" fill="white" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></button>
                `;
                
                const btn = wrap.querySelector('.icon-actions-button');
                btn.onclick = (e) => {
                    e.preventDefault();
                    this.showMenu(icon, btn);
                };

                wrap.querySelector('.icon-link').onclick = (e) => {
                    if (state.isEditMode) e.preventDefault();
                    else if (!icon.link.startsWith('http')) {
                        e.preventDefault();
                        navigator.clipboard.writeText(icon.link);
                        const t = document.getElementById('confirmation-toast');
                        t.style.display = 'block';
                        setTimeout(() => t.style.display = 'none', 2000);
                    }
                };
                return wrap;
            },
            createCategory(id, name, icons, collapsed) {
                const sec = document.createElement('section');
                sec.className = `category-card ${collapsed ? 'collapsed' : ''}`;
                sec.innerHTML = `<div class="category-header"><h2>${name}</h2></div><div class="icons-grid"></div>`;
                const g = sec.querySelector('.icons-grid');
                icons.forEach(i => g.appendChild(this.createIcon(i)));
                sec.querySelector('.category-header').onclick = () => sec.classList.toggle('collapsed');
                return sec;
            },
            showMenu(icon, btn) {
                document.querySelectorAll('.context-menu').forEach(m => m.remove());
                const menu = document.createElement('ul');
                menu.className = 'context-menu';
                menu.innerHTML = `<li id="m-edit">Editar</li><li id="m-pin">${icon.isPinned ? 'Desafixar' : 'Fixar'}</li><li id="m-del" style="color:red">Excluir</li>`;
                btn.parentElement.appendChild(menu);
                
                menu.querySelector('#m-edit').onclick = () => this.openModal(icon);
                menu.querySelector('#m-pin').onclick = () => updateDoc(doc(FirebaseService.db, "icones", icon.id), { isPinned: !icon.isPinned });
                menu.querySelector('#m-del').onclick = () => confirm('Excluir?') && deleteDoc(doc(FirebaseService.db, "icones", icon.id));
                
                setTimeout(() => document.onclick = () => { menu.remove(); document.onclick = null; }, 10);
            },
            openModal(icon = null) {
                const f = document.getElementById('icon-form');
                f.reset();
                if (icon) {
                    f.iconIdInput.value = icon.id;
                    f.iconNameInput.value = icon.name;
                    f.iconLinkInput.value = icon.link;
                    f.iconColorInput.value = icon.color || '#006400';
                    f.iconCategorySelect.value = icon.category;
                }
                document.getElementById('generator-modal-overlay').style.display = 'block';
                document.getElementById('generate-icon-code-section').style.display = 'block';
            }
        };

        const App = {
            init() {
                FirebaseService.init();

                // 1. CARREGAMENTO LOCAL (INSTANTÂNEO)
                const cache = localStorage.getItem('cachedIcons');
                if (cache) {
                    state.allIcons = JSON.parse(cache);
                    UI.render();
                }

                // 2. TEMA E MODO EDIÇÃO SALVOS
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    document.querySelector('#theme-toggle span').textContent = 'Escuro';
                }
                if (localStorage.getItem('editMode') === 'active') {
                    state.isEditMode = true;
                    document.body.classList.add('edit-mode-active');
                }

                // 3. SINCRONIZAÇÃO FIREBASE (CARREGA NOVOS)
                FirebaseService.listen(icons => {
                    state.allIcons = icons;
                    UI.render();
                });

                this.bind();
            },
            bind() {
                document.getElementById('theme-toggle').onclick = () => {
                    const isDark = document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    document.querySelector('#theme-toggle span').textContent = isDark ? 'Escuro' : 'Claro';
                };

                document.getElementById('edit-mode-toggle').onclick = () => {
                    state.isEditMode = !state.isEditMode;
                    document.body.classList.toggle('edit-mode-active', state.isEditMode);
                    localStorage.setItem('editMode', state.isEditMode ? 'active' : 'inactive');
                };

                document.getElementById('search-button-toggle').onclick = () => {
                    const input = document.getElementById('search-input');
                    if (input.classList.toggle('active')) input.focus();
                    else { input.value = ''; state.searchTerm = ''; UI.render(); }
                };

                document.getElementById('search-input').oninput = (e) => {
                    state.searchTerm = e.target.value.toLowerCase();
                    UI.render();
                };

                document.getElementById('auto-publish-button').onclick = () => UI.openModal();
                document.getElementById('close-modal').onclick = () => {
                    document.getElementById('generator-modal-overlay').style.display = 'none';
                    document.getElementById('generate-icon-code-section').style.display = 'none';
                };

                document.getElementById('icon-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const f = e.target;
                    const data = {
                        name: f.iconNameInput.value,
                        link: f.iconLinkInput.value,
                        color: f.iconColorInput.value,
                        category: f.iconCategorySelect.value,
                        updatedAt: serverTimestamp()
                    };
                    
                    if (f.iconIdInput.value) await updateDoc(doc(FirebaseService.db, "icones", f.iconIdInput.value), data);
                    else await addDoc(collection(FirebaseService.db, "icones"), { ...data, isPinned: false, createdAt: serverTimestamp() });
                    
                    document.getElementById('close-modal').click();
                };

                document.getElementById('gratuito-phrase').onclick = () => {
                    const fix = document.getElementById('category-fixados');
                    if (fix) fix.classList.toggle('collapsed');
                };
            }
        };

        App.init();
    </script>
</body>
</html>
